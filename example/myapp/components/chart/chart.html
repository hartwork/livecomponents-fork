{% load livecomponents %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" integrity="sha256-gf+v4Tw34bJXk7Ag1Eb02XOblJ2tt/n3nXCaDK14HC8=" crossorigin="anonymous"></script>
<div {% component_attrs component_id %}>

  <div style="width: 800px; height: 400px;">
    <canvas id="canvas-{{ chart_slug }}" hx-preserve></canvas>
  </div>

  {{ chart_state|json_script:json_script_id }}

  <script {% no_morph %}>
    function initializeChart() {
      const {data, chartType, chartSlug} = JSON.parse(document.getElementById('{{ json_script_id }}').textContent);
      const canvasId = `canvas-${chartSlug}`;
      const ctx = document.getElementById(canvasId);
      if (ctx.chart) {
        ctx.chart.config.type = chartType;
        ctx.chart.data.labels = data.map(d => d.label);
        ctx.chart.data.datasets[0].data = data.map(d => d.value);
        ctx.chart.update();
      } else {
        ctx.chart = new Chart(ctx, {
          type: chartType,
          data: {
            labels: data.map(d => d.label),
            datasets: [{
              data: data.map(d => d.value),
              borderWidth: 1,
              backgroundColor: [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 205, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)',
                'rgba(201, 203, 207, 0.6)',
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 205, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)'
              ],
              borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 159, 64, 1)',
                'rgba(201, 203, 207, 1)',
                'rgba(255, 99, 132, 1)',
                'rgba(54, 162, 235, 1)',
                'rgba(255, 205, 86, 1)',
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      }
    }
    document.addEventListener('htmx:load', initializeChart, {once: true});
  </script>
  <div style="margin-top: 20px; display: flex; gap: 10px;">
    <button hx-post="{% call_command component_id 'add_data_point' %}">
      Add Data Point
    </button>
    <button hx-post="{% call_command component_id 'remove_last_point' %}">
      Remove Last Point
    </button>
    <button hx-post="{% call_command component_id 'change_chart_type' %}">
      Toggle Chart Type ({{ chart_type }})
    </button>
    <button hx-post="{% call_command component_id 'randomize_data' %}">
      Randomize Data
    </button>
  </div>
</div>
